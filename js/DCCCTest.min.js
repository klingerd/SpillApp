function SpillMarker(e){this._listeners=[],this._placeWhenReady=!1,this.year=e.spill_date.slice(0,4),this.date=new Date(e.spill_date),this.material_name=e.material_name,this.contributing_factor=e.contributing_factor,this.program_facility_name=e.program_facility_name.trim(),this._determinePosAndIcon(e)}function initMap(){updateYear(),(map=new google.maps.Map($("#map")[0],{zoom:6,center:{lat:43,lng:-76},backgroundColor:"#d8e8ff",streetViewControl:!1,mapTypeControl:!1,maxZoom:15,minZoom:5,clickableIcons:!1})).fitBounds({north:43.5,south:40.5,west:-76,east:-74}),$.getJSON("guide_data.json",onGuideLoad).fail(function(){console.log("guide load error")}),$.ajax({url:"https://data.ny.gov/resource/dzn2-x287.json?$where=starts_with(waterbody,'HUDSON R')",type:"GET",data:{$limit:75e3,$$app_token:"6VuR0Szvnvt58kUl87cNa4tdF"}}).done(onJSONLoad)}function updateYear(){var e=!1,t=!1;$("#year-title").text(curYear),$("#prev-year").text(curYear-1),$("#next-year").text(curYear+1),curYear===LAST_YEAR&&(e=!0),curYear===FIRST_YEAR&&(t=!0),$("#next-year").prop("disabled",e),$("#prev-year").prop("disabled",t)}function onJSONLoad(e){var t,r;for(r=0;r<e.length;r++)(t=new SpillMarker(e[r])).year==curYear&&(t.place(),placedMarkers.push(t)),markers.push(t);$(".loading-label").addClass("hidden"),$(".img-container img").click(onImageClick)}function onImageClick(){var e=guideNotes[curYear][0];map.setCenter(e.map_link.coords),map.setZoom(e.map_link.zoom),$("html, body").animate({scrollTop:$("#year-title").offset().top},400)}function updateArrow(){guideExists?$(".guide-sheet span")[0].getBoundingClientRect().top+50<=$(window).height()?$("#read-more-arrow").addClass("invisible"):$("#read-more-arrow").removeClass("invisible"):$("#read-more-arrow").addClass("invisible")}function onGuideLoad(e){guideExists=null!=(guideNotes=e)[curYear],populateGuideSheet(),updateArrow(),$(window).scroll(updateArrow),$(window).resize(updateArrow)}function populateGuideSheet(){var e;guideExists?(e=guideNotes[curYear][0],$(".guide-sheet span").text(e.text),null!=e.map_link?($(".guide-sheet .img-container img").attr("src",e.map_link.img),$(".guide-sheet .img-container").removeClass("hidden")):$(".guide-sheet .img-container").addClass("hidden"),$(".guide-sheet").removeClass("hidden")):($(".guide-sheet").addClass("hidden"),$(".guide-sheet img-container").addClass("hidden"))}function changeYear(e){e?curYear<LAST_YEAR&&(curYear++,refreshMarkers()):curYear>FIRST_YEAR&&(curYear--,refreshMarkers())}function refreshMarkers(){var e;for(updateYear(),guideExists=null!=guideNotes[curYear],$("#info-sheet").addClass("hidden"),$("#info-placeholder").removeClass("hidden"),$(".guide-sheet").removeClass("no-border"),null!=selectedMarker&&(selectedMarker.unshowSelected(),selectedMarker=null),populateGuideSheet(),updateArrow();placedMarkers.length>0;)placedMarkers.pop().remove();for(e=0;e<markers.length;e++)markers[e].year==curYear&&(markers[e].place(),placedMarkers.push(markers[e]))}var map,guideNotes,guideExists,selectedMarker,markers=[],placedMarkers=[],curYear=2017,lowZIndex=0,MAP_KEY="AIzaSyAvgbYjsYxgjOb3-Jt0bpv0EoLbJA7aRCs",LAST_YEAR=2017,FIRST_YEAR=1986,GEOCODING_ON=!1;SpillMarker.prototype._determinePosAndIcon=function(e){var t,r,i,a,s;switch(e.material_family){case"Petroleum":t="#000000";break;case"Hazardous Material":t="#c00000";break;case"Oxygenates":t="#007080";break;default:t="#905020"}if(null!=e.quantity&&null!=e.units?("Pounds"==e.units?(r=e.quantity/6,s="lbs"):(r=e.quantity,s="gal"),(i=Math.sqrt(r/10)+5)>25&&(i=25),1,0==r?(i=7,this.amount=""):this.amount=" ("+e.quantity+s+")"):(i=7,this.amount=""),this.icon={path:google.maps.SymbolPath.CIRCLE,strokeWeight:1,fillOpacity:.4,scale:i,strokeColor:t,fillColor:t},null!=e.location_1)this.position={lat:e.location_1.coordinates[1],lng:e.location_1.coordinates[0]};else if(GEOCODING_ON){if(null!=e.location_1_address)a=e.location_1_address+","+e.location_1_city+",NY";else if(null!=e.locality&&null!=e.street_1)a=e.street_1+","+e.locality+",NY";else{if(null==e.street_1)return-1;a=e.street_1+","+e.county+",NY"}a=a.replace(/ /g,"+"),$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+a+"&key="+MAP_KEY,this.onGeocoded.bind(this))}},SpillMarker.prototype._setGmMarker=function(){this.gmMarker=new google.maps.Marker({position:this.position,icon:this.icon,zIndex:20-this.icon.scale,map:map}),this._addListeners()},SpillMarker.prototype._addListeners=function(){this._listeners.push(this.gmMarker.addListener("mouseover",this.onSelected.bind(this))),this._listeners.push(this.gmMarker.addListener("mousedown",this.onSelected.bind(this))),this._listeners.push(this.gmMarker.addListener("mouseout",this.onUnselected.bind(this))),this._listeners.push(this.gmMarker.addListener("mouseup",this.onUnclicked.bind(this)))},SpillMarker.prototype._removeListeners=function(){for(;this._listeners.length>0;)this._listeners.pop().remove()},SpillMarker.prototype.place=function(){null!=this.position?null==this.gmMarker?this._setGmMarker():(this.gmMarker.setMap(map),this._addListeners()):this._placeWhenReady=!0},SpillMarker.prototype.remove=function(){null!=this.gmMarker&&this.gmMarker.setMap(null),this._removeListeners(),this._placeWhenReady=!1},SpillMarker.prototype.unshowSelected=function(){this.icon.strokeWeight=1,this.gmMarker.setIcon(this.icon)},SpillMarker.prototype.showSelected=function(){this.icon.strokeWeight=3,this.gmMarker.setIcon(this.icon)},SpillMarker.prototype.onUnclicked=function(){this.gmMarker.setZIndex(lowZIndex),lowZIndex--},SpillMarker.prototype.onSelected=function(){null!=selectedMarker&&selectedMarker.unshowSelected(),selectedMarker=this,this.showSelected(),$("#info-placeholder").addClass("hidden"),$("#info-sheet .date-div").text(this.date.getMonth()+1+"/"+this.date.getDate()),$("#spill-title").text(this.material_name),$("#spill-amount").text(this.amount),$("#spill-location").text(this.program_facility_name),$("#spill-factor").text(this.contributing_factor.toUpperCase()),$("#info-sheet").removeClass("hidden"),$(".guide-sheet").addClass("no-border")},SpillMarker.prototype.onUnselected=function(){},SpillMarker.prototype.onGeocoded=function(e){var t,r,i=!1;if("OK"==e.status){for(r=e.results[0].address_components,t=1;t<r.length-1;t++)if("NY"===r[t].short_name||"NJ"===r[t].short_name){i=!0;break}i?(this.position=e.results[0].geometry.location,this._placeWhenReady&&this._setGmMarker()):this._placeWhenReady=!1}else this._placeWhenReady=!1};